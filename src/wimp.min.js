!function(){const e={},s={},t={};let r=!1,o=document.querySelectorAll.bind(document);const i=[],a={},n=[];class c{static get pendingRequests(){return s}static get registeredTargets(){return e}static set proxy(e){r=e}static get proxy(){return r}static init(e){o=e||o,window.addEventListener("message",c._listener)}static _listener(e){const o=JSON.parse(e.data),g={data:o,source:e.source,origin:e.origin};switch(o.type){case"readyCheck":o.type="readyResponse",c._postMessage({window:e.source,origin:e.origin},o);break;case"proxyReadyCheck":if(a[o.requestID])return;if(o.type="readyResponse",c._postMessage({window:e.source,origin:e.origin},o),!r)throw"Proxying disabled. Enable it with `Wimp.proxy = true;`";a[o.requestID]={targets:[],pending:{},window:e.source,origin:e.origin};const d=a[o.requestID].targets,h=a[o.requestID].pending;o.targets.forEach(e=>{d.push(...c._getTargetWindows(e))}),d.forEach(e=>{if(n.includes(e.window))return;const s=Math.random().toString(36).substr(2,12);h[s]=e});const p=()=>{if(0==Object.keys(h).length)return o.type="targetsReady",void c._postMessage({window:e.source,origin:e.origin},o);Object.keys(h).forEach(e=>{c._postMessage(h[e],{type:"readyCheck",requestID:e})}),setTimeout(()=>p(),10)};p();break;case"proxyReadyCheckReset":const u=[];o.targets.forEach(e=>{u.push(...c._getTargetWindows(e))}),u.forEach(e=>{-1!==n.indexOf(e.window)&&n.splice(n.indexOf(e.window),1)});break;case"readyResponse":n.includes(e.source)||n.push(e.source),i.some(e=>e.pendingReady[o.requestID]?(delete e.pendingReady[o.requestID],1):e.pendingReadyProxy==o.requestID?(e.proxyReady=!0,1):void 0),Object.keys(a).forEach(e=>{a[e].pending[o.requestID]&&delete a[e].pending[o.requestID]});break;case"targetsReady":i.some(e=>{e.pendingReadyProxy==o.requestID&&(e.isReady=!0,e.readyFunction())});break;case"response":o.success="false"!=o.success,s[o.requestID]?(s[o.requestID](o),delete s[o.requestID]):console.error(`Unrecognized requestID '${o.requestID}' from '${o.request}' request.`);break;case"request":i.forEach(s=>{s.targets.some(t=>{if(t.window==e.source){const t=o.expectResponse?c._responseFactory(e,o.requestID):()=>{};return s.routes[o.request]&&s.routes[o.request](o.data,t),1}})});break;case"proxy":if(!r)throw"Proxying disabled. Enable it with `Wimp.proxy = true;`";c._relay(g);break;case"joinStream":i.forEach(s=>{s.streams[o.name]&&s.streams[o.name].fn(o.data,e)});break;case"streamMessage":i.forEach(e=>{e.listeners[o.name]&&e.listeners[o.name](o.data)}),t[o.name]&&t[o.name].forEach(e=>{c._postMessage(e,o)});break;case"joinProxyStream":if(!r)throw"Proxying disabled. Enable it with `Wimp.proxy = true;`";const y=[];o.targets.forEach(e=>{y.push(...c._getTargetWindows(e))}),o.type="joinStream",delete o.target,y.forEach(e=>{c._postMessage(e,o)}),t[name]?-1==t[o.name].indexOf(e.source)&&t[o.name].push({window:e.source,origin:e.origin}):t[o.name]=[{window:e.source,origin:e.origin}]}}static registerTarget(s,t){const r=[];c._targetsToArrayObject(t).forEach(e=>{r.push(...c._getTargetWindows(e))}),e[s]=r}static _relay(e){const t=[];e.data.targets.forEach(e=>{t.push(...c._getTargetWindows(e))});const r=[],o=Object.assign({},e.data);o.type="request",delete o.target,t.forEach(e=>{const s=Math.random().toString(36).substr(2,12);r.push(s)}),c._postMessage({window:e.source,origin:e.origin},{type:"response",requestID:e.data.requestID,requestIDs:r}),t.forEach((t,i)=>{o.requestID=r[i],s[r[i]]=(s=>{c._postMessage({window:e.source,origin:e.origin},s)}),c._postMessage({window:t.window,origin:t.origin},o)})}static _postMessage(e,s){e.window.postMessage(JSON.stringify(s),e.origin)}static error(e,s,t){const r={success:"false",error:{message:s},type:"response"};t&&(r.requestID=t),c._postMessage({window:e.window,origin:e.origin},r)}static _responseFactory(e,s){const t=t=>{const r={data:t,requestID:s,success:!0,type:"response"};c._postMessage({window:e.source,origin:e.origin},r)};return t.error=(t=>{t=t||"An error occured",c.error({window:e.source,origin:e.origin},t,s)}),t}static _targetsToArrayObject(e){Array.isArray(e)||(e=[e]);for(let s=0;s<e.length;s++)!e[s].postMessage&&e[s].selector||(e[s]={selector:e[s],origin:"*"}),e[s].origin||(e[s].origin="*");return e}static _getTargetWindows(s){if("string"==typeof s.selector){if("*"==s.selector)return Array.prototype.slice.call(window.frames).map(e=>({window:e,origin:s.origin}));if(s.selector in e)return e[s.selector];return Array.prototype.slice.call(o(s.selector)).filter(e=>e.contentWindow).map(e=>({window:e.contentWindow,origin:s.origin}))}return[{window:s.selector,origin:s.origin}]}constructor(e,s){i.push(this),this.routes={},this.streams={},this.listeners={},this.pendingReady={},this.proxyReady=!1,this.proxyTargetsReady=!1,this.readyFunction=(()=>{}),this.targets=[],s&&s.postMessage&&(s={selector:s,origin:"*"}),e=c._targetsToArrayObject(e),this.selectors=[],e.forEach(e=>{"string"==typeof e.selector&&this.selectors.push(e)}),this.proxy=!!s&&c._getTargetWindows(s)[0],e.forEach(e=>{this.targets.push(...c._getTargetWindows(e))}),this.readyCheck(!1)}readyCheck(e){if(this.isReady=!1,e&&(this.targets.forEach(e=>{-1!==n.indexOf(e.window)&&n.splice(n.indexOf(e.window),1)}),this.proxy&&(c._postMessage(this.proxy,{type:"proxyReadyCheckReset",targets:this.selectors}),this.proxyReady=!1)),this.proxy){this.pendingReadyProxy=Math.random().toString(36).substr(2,12);const e=()=>{c._postMessage(this.proxy,{type:"proxyReadyCheck",targets:this.selectors,requestID:this.pendingReadyProxy}),this.proxyReady||setTimeout(()=>e(),10)};e()}else this.targets.forEach(e=>{if(n.includes(e.window))return;const s=Math.random().toString(36).substr(2,12);this.pendingReady[s]=e;const t=()=>{if(0==Object.keys(this.pendingReady).length)return this.isReady=!0,void this.readyFunction();Object.keys(this.pendingReady).forEach(e=>{c._postMessage(this.pendingReady[e],{type:"readyCheck",requestID:e})}),setTimeout(()=>t(),10)};t()})}request(e,t,r){if("string"!=typeof e&&(r=t=e),"function"==typeof t&&(r=t,t=void 0),(t=t||{}).request=t.request||e,!t.request)throw"Request must be specified";0!=t.expectResponse&&(t.expectResponse=!0);const o=[];if(this.proxy){const e=Math.random().toString(36).substr(2,12);t.requestID=e,t.type="proxy",t.targets=this.selectors;const i=e=>{if(e.requestIDs.forEach(e=>{r?s[e]=r:o.push(new Promise((t,r)=>{s[e]=t}))}),!r)return 1==o.length?o[0]:o};if(!r)return new Promise((r,o)=>{s[e]=r,c._postMessage(this.proxy,t)}).then(e=>i(e));s[e]=i,c._postMessage(this.proxy,t)}else if(this.targets.forEach(e=>{t.requestID=Math.random().toString(36).substr(2,12),t.type="request",t.expectResponse?(r?s[t.requestID]=r:o.push(new Promise((e,r)=>{s[t.requestID]=e})),c._postMessage(e,t)):c._postMessage(e,t)}),!r)return 1==o.length?o[0]:o}on(e,s){this.routes[e]=s}createStream(e,s,t){if("string"!=typeof e&&(t=s=e),"function"==typeof s&&(t=s,s=void 0),(s=s||{}).name=s.name||e,!s.name)throw"Name must be specified";return this.streams[e]={fn:(s,r)=>{this.streams[e].targets.indexOf(r.source)<0&&this.streams[e].targets.push({window:r.source,origin:r.origin}),t(s,s=>{c._postMessage({window:r.source,origin:r.origin},{type:"streamMessage",name:e,data:s})})},targets:[]},{emit:t=>{s={name:e,type:"streamMessage",data:t},this.streams[e].targets.forEach(e=>{c._postMessage(e,s)})}}}listen(e,s){this.proxy?c._postMessage(this.proxy,{type:"joinProxyStream",name:e,targets:this.selectors}):this.targets.forEach(s=>{c._postMessage(s,{type:"joinStream",name:e})}),this.listeners[e]=s}addTarget(e){(e=c._targetsToArrayObject(e)).forEach(e=>{"string"==typeof e.selector&&this.selectors.push(e)}),this.targets.push(...c._getTargetWindows(e))}requery(){this.targets=[],this.selectors.forEach(e=>{this.targets.push(...c._getTargetWindows(e))})}hashSync(){this.on("hashchange",(e,s)=>{window.location.hash=e.hash}),window.addEventListener("hashchange",e=>{console.log(e),this.request("hashchange",{data:{hash:e.newURL.split("#")[1]},expectResponse:!1})},!1)}ready(e){return this.isReady||this.proxy&&this.proxyReady?e?e():Promise.resolve():e?void(this.readyFunction=e):new Promise(e=>{this.readyFunction=e})}destroy(){i.splice(i.indexOf(this),1)}}window.Wimp=c}();