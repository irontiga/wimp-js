!function(){const e={},t={},s={};let r=!1,o=document.querySelectorAll.bind(document);const i=[],a={},n=[];class c{static get pendingRequests(){return t}static get registeredTargets(){return e}static set proxy(e){r=e}static get proxy(){return r}static init(e){o=e||o,window.addEventListener("message",c._listener)}static _listener(e){const o=JSON.parse(e.data),g={data:o,source:e.source,origin:e.origin};switch(o.type){case"readyCheck":o.type="readyResponse",c._postMessage({window:e.source,origin:e.origin},o);break;case"proxyReadyCheck":if(a[o.requestID])return;if(o.type="readyResponse",c._postMessage({window:e.source,origin:e.origin},o),!r)throw"Proxying disabled. Enable it with `Wimp.proxy = true;`";a[o.requestID]={targets:[],pending:{},window:e.source,origin:e.origin};const d=a[o.requestID].targets,p=a[o.requestID].pending;o.targets.forEach(e=>{d.push(...c._getTargetWindows(e))}),d.forEach(t=>{if(n.includes(t.window))return;const s=Math.random().toString(36).substr(2,12);p[s]=t;const r=()=>{if(0==Object.keys(p).length)return o.type="targetsReady",void c._postMessage({window:e.source,origin:e.origin},o);Object.keys(p).forEach(e=>{c._postMessage(p[e],{type:"readyCheck",requestID:e})}),setTimeout(()=>r(),10)};r()});break;case"proxyReadyCheckReset":const u=[];o.targets.forEach(e=>{u.push(...c._getTargetWindows(e))}),u.forEach(e=>{-1!==n.indexOf(e.window)&&n.splice(n.indexOf(e.window),1)});break;case"readyResponse":n.includes(e.source)||n.push(e.source),i.some(e=>e.pendingReady[o.requestID]?(delete e.pendingReady[o.requestID],1):e.pendingReadyProxy==o.requestID?(e.proxyReady=!0,1):void 0),Object.keys(a).forEach(e=>{a[e].pending[o.requestID]&&delete a[e].pending[o.requestID]});break;case"targetsReady":i.some(e=>{e.pendingReadyProxy==o.requestID&&(e.isReady=!0,e.readyFunction())});break;case"response":t[o.requestID]?(t[o.requestID](o),delete t[o.requestID]):console.error(`Unrecognized requestID '${o.requestID}' from '${o.request}' request.`);break;case"request":i.forEach(t=>{t.targets.some(s=>{if(s.window==e.source){const s=o.expectResponse?c._responseFactory(e,o.requestID):()=>{};return t.routes[o.request]&&t.routes[o.request](o.data,s),1}})});break;case"proxy":if(!r)throw"Proxying disabled. Enable it with `Wimp.proxy = true;`";c._relay(g);break;case"joinStream":i.forEach(t=>{t.streams[o.name]&&t.streams[o.name].fn(o.data,e)});break;case"streamMessage":i.forEach(e=>{e.listeners[o.name]&&e.listeners[o.name](o.data)}),s[o.name]&&s[o.name].forEach(e=>{c._postMessage(e,o)});break;case"joinProxyStream":if(!r)throw"Proxying disabled. Enable it with `Wimp.proxy = true;`";const h=[];o.targets.forEach(e=>{h.push(...c._getTargetWindows(e))}),o.type="joinStream",delete o.target,h.forEach(e=>{c._postMessage(e,o)}),s[name]?-1==s[o.name].indexOf(e.source)&&s[o.name].push(e.source):s[o.name]=[e.source]}}static registerTarget(t,s){const r=[];c._targetsToArrayObject(s).forEach(e=>{r.push(...c._getTargetWindows(e))}),e[t]=r}static _relay(e){const s=[];e.data.targets.forEach(e=>{s.push(...c._getTargetWindows(e))});const r=[],o=Object.assign({},e.data);o.type="request",delete o.target,s.forEach(e=>{const t=Math.random().toString(36).substr(2,12);r.push(t)}),c._postMessage({window:e.source,origin:e.origin},{type:"response",requestID:e.data.requestID,requestIDs:r}),s.forEach((s,i)=>{o.requestID=r[i],t[r[i]]=(t=>{c._postMessage({window:e.source,origin:e.origin},t)}),c._postMessage({window:s.window,origin:s.origin},o)})}static _postMessage(e,t){e.window.postMessage(JSON.stringify(t),e.origin)}static error(e,t,s){const r={success:"false",error:{message:t},type:"response"};s&&(r.requestID=s),c._postMessage({window:e.window,origin:e.origin},r)}static _responseFactory(e,t){const s=s=>{const r={data:s,requestID:t,success:!0,type:"response"};c._postMessage({window:e.source,origin:e.origin},r)};return s.error=(s=>{s=s||"An error occured",c.error({window:e.source,origin:e.origin},s,t)}),s}static _targetsToArrayObject(e){Array.isArray(e)||(e=[e]);for(let t=0;t<e.length;t++)!e[t].postMessage&&e[t].selector||(e[t]={selector:e[t],origin:"*"}),e[t].origin||(e[t].origin="*");return e}static _getTargetWindows(t){if("string"==typeof t.selector){if("*"==t.selector)return Array.prototype.slice.call(window.frames).map(e=>({window:e,origin:t.origin}));if(t.selector in e)return e[t.selector];return Array.prototype.slice.call(o(t.selector)).filter(e=>e.contentWindow).map(e=>({window:e.contentWindow,origin:t.origin}))}return[{window:t.selector,origin:t.origin}]}constructor(e,t){i.push(this),this.routes={},this.streams={},this.listeners={},this.pendingReady={},this.proxyReady=!1,this.proxyTargetsReady=!1,this.readyFunction=(()=>{}),this.targets=[],t&&!t.selector&&(t={selector:t,origin:"*"}),e=c._targetsToArrayObject(e),this.selectors=[],e.forEach(e=>{"string"==typeof e.selector&&this.selectors.push(e)}),this.proxy=!!t&&c._getTargetWindows(t)[0],e.forEach(e=>{this.targets.push(...c._getTargetWindows(e))}),this.readyCheck(!1)}readyCheck(e){if(this.isReady=!1,e&&(this.targets.forEach(e=>{-1!==n.indexOf(e.window)&&n.splice(n.indexOf(e.window),1)}),this.proxy&&c._postMessage(this.proxy,{type:"proxyReadyCheckReset",targets:this.selectors})),this.proxy){this.pendingReadyProxy=Math.random().toString(36).substr(2,12);const e=()=>{c._postMessage(this.proxy,{type:"proxyReadyCheck",targets:this.selectors,requestID:this.pendingReadyProxy}),this.proxyReady||setTimeout(()=>e(),10)};e()}else this.targets.forEach(e=>{if(n.includes(e.window))return;const t=Math.random().toString(36).substr(2,12);this.pendingReady[t]=e;const s=()=>{if(0==Object.keys(this.pendingReady).length)return this.isReady=!0,void this.readyFunction();Object.keys(this.pendingReady).forEach(e=>{c._postMessage(this.pendingReady[e],{type:"readyCheck",requestID:e})}),setTimeout(()=>s(),10)};s()})}request(e,s,r){if("string"!=typeof e&&(r=s=e),"function"==typeof s&&(r=s,s=void 0),(s=s||{}).request=s.request||e,!s.request)throw"Request must be specified";0!=s.expectResponse&&(s.expectResponse=!0);const o=[];if(this.proxy){const e=Math.random().toString(36).substr(2,12);s.requestID=e,s.type="proxy",s.targets=this.selectors;const i=e=>{if(e.requestIDs.forEach(e=>{r?t[e]=r:o.push(new Promise((s,r)=>{t[e]=s}))}),!r)return 1==o.length?o[0]:o};if(!r)return new Promise((r,o)=>{t[e]=r,c._postMessage(this.proxy,s)}).then(e=>i(e));t[e]=i,c._postMessage(this.proxy,s)}else if(this.targets.forEach(e=>{s.requestID=Math.random().toString(36).substr(2,12),s.type="request",s.expectResponse?(r?t[s.requestID]=r:o.push(new Promise((e,r)=>{t[s.requestID]=e})),c._postMessage(e,s)):c._postMessage(e,s)}),!r)return 1==o.length?o[0]:o}on(e,t){this.routes[e]=t}createStream(e,t,s){if("string"!=typeof e&&(s=t=e),"function"==typeof t&&(s=t,t=void 0),(t=t||{}).name=t.name||e,!t.name)throw"Name must be specified";return this.streams[e]={fn:(t,r)=>{this.streams[e].targets.indexOf(r.source)<0&&this.streams[e].targets.push(r.source),s(t,t=>{c._postMessage({window:r.source,origin:r.origin},{type:"streamMessage",name:e,data:t})})},targets:[]},{emit:s=>{t={name:e,type:"streamMessage",data:s},this.streams[e].targets.forEach(e=>{c._postMessage(e,t)})}}}listen(e,t){this.proxy?c._postMessage(this.proxy,{type:"joinProxyStream",name:e,targets:this.selectors}):this.targets.forEach(t=>{c._postMessage(t,{type:"joinStream",name:e})}),this.listeners[e]=t}addTarget(e){(e=c._targetsToArrayObject(e)).forEach(e=>{"string"==typeof e.selector&&this.selectors.push(e)}),this.targets.push(...c._getTargetWindows(e))}requery(){this.targets=[],this.selectors.forEach(e=>{this.targets.push(...c._getTargetWindows(e))})}ready(e){return this.isReady?e?e():Promise.resolve():e?void(this.readyFunction=e):new Promise(e=>{this.readyFunction=e})}destroy(){i.splice(i.indexOf(this),1)}}window.Wimp=c}();